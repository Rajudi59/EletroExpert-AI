<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ElectroExpert AI - Acervo T√©cnico</title>
    <style>
        :root {
            --azul-claro: #87CEEB; 
            --azul-claro-hover: #00BFFF;
            --azul-3d-sombra: #5f9ea0;
            --danger: #d9534f;
        }

        body { 
            font-family: 'Segoe UI', sans-serif; 
            background: linear-gradient(rgba(0, 0, 0, 0.4), rgba(0, 0, 0, 0.4)), 
                        url('acervo/fundo-industrial.png'); 
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            margin: 0; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            min-height: 100vh;
        }
        
        .header-container { 
            width: 100%; 
            padding: 20px 25px; 
            box-sizing: border-box; 
            display: flex; 
            align-items: center; 
            background: rgba(255, 255, 255, 0.9);
            box-shadow: 0 2px 15px rgba(0,0,0,0.3);
        }

        .logo { color: #005792; font-weight: bold; font-size: 20px; display: flex; align-items: center; }
        .logo span { background: #ffcc00; color: #000; padding: 2px 8px; border-radius: 4px; margin-right: 10px; }

        .container { 
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(5px);
            padding: 30px; 
            border-radius: 15px; 
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 15px 35px rgba(0,0,0,0.4); 
            width: 92%; 
            max-width: 650px; 
            margin: 40px 0;
        }

        textarea { 
            width: 100%; height: 110px; padding: 15px; border: 2px solid #eee;
            border-radius: 12px; font-size: 16px; box-sizing: border-box; resize: none; margin-bottom: 20px;
            outline: none; transition: border-color 0.3s;
        }
        textarea:focus { border-color: var(--azul-claro); }

        .btn-group { display: flex; gap: 12px; }
        .btn-base {
            border: none; border-radius: 12px; color: white; font-weight: bold; cursor: pointer;
            display: flex; align-items: center; justify-content: center; background: var(--azul-claro);
            box-shadow: 0 5px 0 var(--azul-3d-sombra); transition: all 0.1s; flex: 1; padding: 18px;
            font-size: 16px;
        }
        .btn-base:active { transform: translateY(3px); box-shadow: 0 2px 0 var(--azul-3d-sombra); }
        .recording { background: #ff4d4d !important; box-shadow: 0 2px 0 #b30000 !important; }

        #resultado { 
            width: 100%; margin-top: 25px; display: none; padding: 25px; 
            background: #fff; border-radius: 12px; border: 1px solid #ddd;
            animation: slideIn 0.4s ease-out;
        }

        @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .img-acervo { width: 100%; border-radius: 8px; border: 3px solid #005792; margin-top: 20px; }
        .alerta { 
            background: #fff3f3; border-left: 6px solid var(--danger); 
            padding: 15px; font-size: 14px; margin-bottom: 15px; color: #333;
        }
    </style>
</head>
<body>

<div class="header-container">
    <div class="logo"><span>‚ö°</span> ElectroExpert AI - Acervo T√©cnico</div>
</div>

<div class="container">
    <textarea id="pergunta" placeholder="Segure o üé§ para falar ou digite sua d√∫vida t√©cnica..."></textarea>
    
    <div class="btn-group">
        <button class="btn-base" onclick="processarEntrada()">ENVIAR</button>
        <button id="btn-mic" class="btn-base">üé§</button>
        <label for="file-input" class="btn-base" style="cursor:pointer; font-size:20px;">üì∑</label>
        <input type="file" id="file-input" accept="image/*" capture="environment" style="display: none;">
    </div>

    <div id="resultado">
        <div id="conteudo"></div>
        <div id="fonte" style="font-size: 11px; color: #888; margin-top: 20px; text-align: center; font-weight: bold;"></div>
    </div>
</div>

<script>
    const meuAcervo = [
        {
            chaves: ["estrela", "tri√¢ngulo", "partida"],
            titulo: "Partida Estrela-Tri√¢ngulo",
            imagem: "acervo/estrela-triangulo.png",
            obs: "Nota T√©cnica: Verifique o intertravamento el√©trico e o ajuste do rel√© t√©rmico (RT) para prote√ß√£o do motor conforme NR-10."
        },
        {
            chaves: ["l√¢mpada", "simples", "interruptor"],
            titulo: "L√¢mpada Simples e Interruptor",
            imagem: "acervo/interruptor-simples.png",
            obs: "Seguran√ßa NBR 5410: O condutor de fase deve sempre ser interrompido pelo interruptor, garantindo que o bocal fique desenergizado ao desligar."
        }
    ];

    const textarea = document.getElementById('pergunta');
    const btnMic = document.getElementById('btn-mic');
    const conteudoDiv = document.getElementById('conteudo');
    const resultadoDiv = document.getElementById('resultado');

    // --- FUN√á√ÉO PRINCIPAL: BUSCA LOCAL + BACKEND IA ---
    async function processarEntrada() {
        const texto = textarea.value.toLowerCase().trim();
        if (!texto) return;

        // 1. TENTA BUSCA LOCAL (DIAGRAMAS R√ÅPIDOS)
        const achouLocal = meuAcervo.find(item => 
            item.chaves.some(chave => texto.includes(chave))
        );

        if (achouLocal) {
            mostrarNoSite(achouLocal);
            return;
        }

        // 2. SE N√ÉO ACHOU LOCAL, CHAMA O BACKEND (IA + MANUAIS PDF)
        resultadoDiv.style.display = 'block';
        conteudoDiv.innerHTML = "<div class='alerta' style='border-left-color: #00BFFF; background: #f0f7ff;'><strong>üîç Vasculhando manuais de Sensores, Inversores e Controladores no acervo...</strong></div>";

        try {
            const response = await fetch("/server", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ question: texto })
            });

            const data = await response.json();

            if (data.answer) {
                conteudoDiv.innerHTML = `
                    <div class="alerta" style="border-left-color: #005792; background: #f0f7ff;">
                        <strong>üí° Instru√ß√£o T√©cnica do Acervo:</strong><br><br>
                        ${data.answer.replace(/\n/g, '<br>')}
                    </div>
                `;
                document.getElementById('fonte').innerText = "ORIGEM: INTELIG√äNCIA ARTIFICIAL + MANUAIS PDF";
            }
        } catch (error) {
            conteudoDiv.innerHTML = "<div class='alerta'>‚ö†Ô∏è Servidor n√£o respondeu. Verifique se o backend est√° rodando na Vercel.</div>";
        }
    }

    function mostrarNoSite(item) {
        resultadoDiv.style.display = 'block';
        conteudoDiv.innerHTML = `
            <div class="alerta">
                <strong>‚ö†Ô∏è PROTOCOLO DE SEGURAN√áA OBRIGAT√ìRIO:</strong><br>
                Uso de EPIs, EPCs e aplica√ß√£o do LOTO antes de qualquer interven√ß√£o.
            </div>
            <h3 style="color:#005792; margin-top:0; font-size: 22px;">${item.titulo}</h3>
            <p style="line-height: 1.6; color: #444;">${item.obs}</p>
            <img src="${item.imagem}" class="img-acervo" onerror="this.src='https://via.placeholder.com/600x400?text=Diagrama+em+Atualiza√ß√£o'">
        `;
        document.getElementById('fonte').innerText = "ORIGEM: BASE DE DADOS T√âCNICA LOCAL";
        textarea.value = "";
    }

    // --- L√ìGICA DA C√ÇMERA (FOTO DO COMPONENTE) ---
    document.getElementById('file-input').addEventListener('change', async function(e) {
        const file = e.target.files[0];
        if (!file) return;

        resultadoDiv.style.display = 'block';
        conteudoDiv.innerHTML = "<strong>üì∏ Analisando imagem conforme manuais do acervo...</strong>";

        const reader = new FileReader();
        reader.onload = async function(event) {
            const base64 = event.target.result.split(',')[1];
            try {
                const response = await fetch("/server", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ 
                        question: "Analise esta foto t√©cnica conforme o acervo de manuais.",
                        image: base64
                    })
                });
                const data = await response.json();
                conteudoDiv.innerHTML = `<strong>An√°lise Visual:</strong><br>${data.answer.replace(/\n/g, '<br>')}`;
                document.getElementById('fonte').innerText = "ORIGEM: VIS√ÉO COMPUTACIONAL + ACERVO";
            } catch (err) {
                conteudoDiv.innerHTML = "<div class='alerta'>Erro ao processar imagem.</div>";
            }
        };
        reader.readAsDataURL(file);
    });

    // --- RECONHECIMENTO DE VOZ ---
    const Speech = window.SpeechRecognition || window.webkitSpeechRecognition;
    if (Speech) {
        const rec = new Speech();
        rec.lang = 'pt-BR';
        const start = (e) => { e.preventDefault(); rec.start(); btnMic.classList.add('recording'); };
        const stop = (e) => { e.preventDefault(); rec.stop(); btnMic.classList.remove('recording'); };
        btnMic.addEventListener('mousedown', start);
        btnMic.addEventListener('mouseup', stop);
        btnMic.addEventListener('touchstart', start);
        btnMic.addEventListener('touchend', stop);
        rec.onresult = (e) => {
            textarea.value = e.results[0][0].transcript;
            setTimeout(processarEntrada, 600);
        };
    }
</script>
</body>
</html>
